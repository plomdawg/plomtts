# ğŸ PlomTTS Client PyPI Deployment Makefile
# Makefile for building and deploying plomtts-client to PyPI

.PHONY: help clean build test test-live check upload upload-test install-dev lint format

# Default target
help:
	@echo "ğŸ“¦ PlomTTS Client PyPI Deployment"
	@echo ""
	@echo "Available targets:"
	@echo "  ğŸ§¹ clean         - Remove build artifacts and cache files"
	@echo "  ğŸ—ï¸  build        - Build distribution packages"
	@echo "  ğŸ§ª test          - Run tests (excludes live tests)"
	@echo "  ğŸŒ test-live     - Run live integration tests"
	@echo "  âœ… check         - Check package integrity"
	@echo "  ğŸ¤– deploy-info   - Show information about automated deployment"
	@echo "  ğŸ› ï¸  install-dev  - Install in development mode"
	@echo "  ğŸ¨ lint          - Run linting checks"
	@echo "  âœ¨ format        - Format code with black and isort"
	@echo "  ğŸ”„ all           - Clean, build, test, and check (no upload - automated via GitHub)"

# Variables
PYTHON := python3
PIP := pip3
TWINE := twine

# Clean build artifacts
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	rm -rf build/
	rm -rf dist/
	rm -rf *.egg-info/
	find . -type d -name __pycache__ -exec rm -rf {} +
	find . -type f -name "*.pyc" -delete
	@echo "âœ… Clean complete"

# Install development dependencies
install-dev:
	@echo "ğŸ› ï¸ Installing development dependencies..."
	"${PIP}" install -e .[dev]
	"${PIP}" install build twine
	@echo "âœ… Development environment ready"

# Format code
format:
	@echo "âœ¨ Formatting code..."
	black .
	isort .
	@echo "âœ… Code formatted"

# Run linting
lint:
	@echo "ğŸ¨ Running linting checks..."
	black --check .
	isort --check-only .
	@echo "âœ… Linting complete"

# Run tests (excluding live tests)
test:
	@echo "ğŸ§ª Running tests (excluding live tests)..."
	pytest tests/ --verbose -m "not live"
	@echo "âœ… Tests complete"

# Run live integration tests
test-live:
	@echo "ğŸŒ Running live integration tests..."
	pytest tests/ --verbose -m live
	@echo "âœ… Live tests complete"

# Build distribution packages
build: clean
	@echo "ğŸ—ï¸ Building distribution packages..."
	"${PYTHON}" -m build
	@echo "âœ… Build complete"

# Check package integrity
check: build
	@echo "âœ… Checking package integrity..."
	"${TWINE}" check dist/*
	@echo "âœ… Package check complete"

# Complete workflow for testing
all: clean install-dev format lint test check
	@echo "ğŸš€ Ready for deployment! Push to main branch to auto-deploy to PyPI."

# Version bump helpers
bump-patch:
	@echo "ğŸ”¢ Bumping patch version..."
	@current_version="$$(grep 'version=' setup.py | cut -d'"' -f2)"; \
	new_version="$$(echo "$${current_version}" | awk -F. '{$$NF = $$NF + 1;} 1' | sed 's/ /./g')"; \
	sed -i "s/version=\"$${current_version}\"/version=\"$${new_version}\"/" setup.py; \
	echo "ğŸ“ˆ Version bumped from $${current_version} to $${new_version}"

bump-minor:
	@echo "ğŸ”¢ Bumping minor version..."
	@current_version="$$(grep 'version=' setup.py | cut -d'"' -f2)"; \
	new_version="$$(echo "$${current_version}" | awk -F. '{$$(NF-1) = $$(NF-1) + 1; $$NF = 0;} 1' | sed 's/ /./g')"; \
	sed -i "s/version=\"$${current_version}\"/version=\"$${new_version}\"/" setup.py; \
	echo "ğŸ“ˆ Version bumped from $${current_version} to $${new_version}"

bump-major:
	@echo "ğŸ”¢ Bumping major version..."
	@current_version="$$(grep 'version=' setup.py | cut -d'"' -f2)"; \
	new_version="$$(echo "$${current_version}" | awk -F. '{$$(NF-2) = $$(NF-2) + 1; $$(NF-1) = 0; $$NF = 0;} 1' | sed 's/ /./g')"; \
	sed -i "s/version=\"$${current_version}\"/version=\"$${new_version}\"/" setup.py; \
	echo "ğŸ“ˆ Version bumped from $${current_version} to $${new_version}"

