# ğŸ³ PlomTTS Local Development Makefile
# Makefile for local development, testing, and Docker Compose management

.PHONY: help run stop logs clean dev test test-live

help: ## ğŸ“‹ Show available targets
	@echo "ğŸ³ PlomTTS Local Development"
	@echo ""
	@echo "Available targets:"
	@awk 'BEGIN {FS = ":.*##"; printf "\n"} /^[a-zA-Z_-]+:.*##/ { printf "  %-15s %s\n", $$1, $$2 }' $(MAKEFILE_LIST)
	@echo ""
	@echo "â„¹ï¸  Docker images are automatically built and published via GitHub Actions"
	@echo "   Push to main branch or create a tag to trigger deployment"

run: ## â–¶ï¸ Run container locally for testing
	@echo "â–¶ï¸ Running PlomTTS container locally..."
	@echo "ğŸŒ Starting on port 8420..."
	docker compose up -d --build
	@echo "âœ… Container started!"
	@echo "ğŸ”— Access at: http://localhost:8420"
	@echo "ğŸ“‹ Use 'make logs' to see output"
	@echo "â¹ï¸ Use 'make stop' to stop the container"

stop: ## â¹ï¸ Stop running containers
	@echo "â¹ï¸ Stopping PlomTTS containers..."
	docker compose down
	@echo "âœ… Containers stopped"

clean: ## ğŸ§¹ Clean up Docker resources
	@echo "ğŸ§¹ Cleaning up Docker resources..."
	docker compose down --volumes --remove-orphans
	docker system prune -f
	@echo "âœ… Cleanup complete"

logs: ## ğŸ“‹ Show container logs
	@echo "ğŸ“‹ Showing PlomTTS container logs..."
	docker compose logs -f

dev: clean run ## ğŸ”„ Complete local development setup
	@echo "ğŸ‰ Local development environment ready!"
	@echo "ğŸ“‹ Summary:"
	@echo "  - âœ… Cleaned up old resources"
	@echo "  - âœ… Started PlomTTS containers"
	@echo ""
	@echo "ğŸ”— Access your application at:"
	@echo "   http://localhost:8420 (PlomTTS API)"
	@echo "   http://localhost:7860 (Fish Speech UI)"

test: ## ğŸ§ª Run tests
	@echo "ğŸ§ª Running tests..."
	pytest tests/ --verbose -m "not live"
	@echo "âœ… Tests complete"

test-live: ## ğŸŒ Run live integration tests
	@echo "ğŸŒ Running live integration tests..."
	pytest tests/ --verbose -m live
	@echo "âœ… Live tests complete"
